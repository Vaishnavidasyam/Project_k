<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance</title>
    <link rel="stylesheet" href="styles11.css" />
    <style>
      .counter-btn {
        cursor: pointer;
        margin: 0 5px;
        padding: 2px 5px;
      }
      .delete-btn {
        cursor: pointer;
        color: red;
        border: none;
        background: none;
      }
      .adjust-container {
        display: flex;
        align-items: center;
      }
      .adjust-container span {
        margin: 0 5px;
        min-width: 20px;
        text-align: center;
      }
      .percentage {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <img src="icon.png" alt="Logo" class="logo-icon" />
        University Timetable
      </div>
      <nav class="nav-links">
        <a href="#">Home</a>
        <a href="#">Dashboard</a>
        <a href="#">Logout</a>
      </nav>
    </header>

    <div class="container">
      <h2>Attendance Record</h2>
      <table id="attendanceTable">
        <thead>
          <tr>
            <th>S.No</th>
            <th>Name</th>
            <th>Roll No</th>
            <th>Classes Attended</th>
            <th>Total Classes</th>
            <th>Percentage</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="studentBody"></tbody>
      </table>

      <div class="buttons">
        <button class="back" onclick="window.history.back()">
          <img src="back.png" alt="Back Icon" class="btn-icon left" />
          Back
        </button>
        <button
          class="add-student"
          onclick="window.location.href='staff4.html'"
        >
          Add Student
          <img src="plus.png" alt="Plus Icon" class="btn-icon right" />
        </button>
      </div>
    </div>

    <script>
      function updatePercentage(row) {
        const attendedEl = row.querySelector(".attended-value");
        const totalEl = row.querySelector(".total-value");
        const percentEl = row.querySelector(".percentage");

        let attended = parseInt(attendedEl.textContent) || 0;
        let total = parseInt(totalEl.textContent) || 0;
        let percentage = total > 0 ? Math.round((attended / total) * 100) : 0;

        percentEl.textContent = percentage + "%";
        percentEl.style.color = percentage < 75 ? "red" : "green";
      }

      function rearrangeSerialNumbers() {
        const rows = document.querySelectorAll("#studentBody tr");
        rows.forEach((row, index) => {
          row.cells[0].textContent = index + 1;
          row.setAttribute("data-index", index);
        });
      }

      function adjustStoredCount(btn, type, delta) {
        const container = btn.parentElement;
        const valueSpan = container.querySelector(
          type === "attended" ? ".attended-value" : ".total-value"
        );
        const row = btn.closest("tr");
        const index = row.getAttribute("data-index");
        let students = JSON.parse(localStorage.getItem("students")) || [];

        let currentValue = parseInt(valueSpan.textContent);
        let totalValue = parseInt(
          row.querySelector(".total-value").textContent
        );
        let attendedValue = parseInt(
          row.querySelector(".attended-value").textContent
        );
        let newValue = currentValue + delta;

        if (newValue < 0) return;

        if (type === "attended") {
          if (newValue > totalValue) return;
        } else {
          if (newValue < attendedValue) {
            alert("Total classes cannot be less than attended classes.");
            return;
          }
        }

        valueSpan.textContent = newValue;

        if (students[index]) {
          if (type === "attended") {
            students[index].attended = newValue;
          } else {
            students[index].total = newValue;
            if (students[index].attended > newValue) {
              students[index].attended = newValue;
              row.querySelector(".attended-value").textContent = newValue;
            }
          }
          localStorage.setItem("students", JSON.stringify(students));
        }

        updatePercentage(row);
      }

      function deleteStudent(btn) {
        if (!confirm("Are you sure you want to delete this student?")) return;

        const row = btn.closest("tr");
        const index = row.getAttribute("data-index");
        let students = JSON.parse(localStorage.getItem("students")) || [];

        if (!isNaN(index)) {
          students.splice(index, 1);
          localStorage.setItem("students", JSON.stringify(students));
        }

        row.remove();
        rearrangeSerialNumbers();
      }

      window.addEventListener("DOMContentLoaded", () => {
        const students = JSON.parse(localStorage.getItem("students")) || [];
        const tbody = document.getElementById("studentBody");

        students.forEach((student, index) => {
          const tr = document.createElement("tr");
          tr.setAttribute("data-index", index);
          tr.innerHTML = `
            <td></td>
            <td>${student.name}</td>
            <td>${student.roll}</td>
            <td>
              <div class="adjust-container">
                <button class="counter-btn" title="Decrease Attended" onclick="adjustStoredCount(this, 'attended', -1)">-</button>
                <span class="attended-value">${student.attended || 0}</span>
                <button class="counter-btn" title="Increase Attended" onclick="adjustStoredCount(this, 'attended', 1)">+</button>
              </div>
            </td>
            <td>
              <div class="adjust-container">
                <button class="counter-btn" title="Decrease Total" onclick="adjustStoredCount(this, 'total', -1)">-</button>
                <span class="total-value">${student.total || 0}</span>
                <button class="counter-btn" title="Increase Total" onclick="adjustStoredCount(this, 'total', 1)">+</button>
              </div>
            </td>
            <td class="percentage">0%</td>
            <td>
              <button class="delete-btn" onclick="deleteStudent(this)">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
          updatePercentage(tr);
        });

        rearrangeSerialNumbers();
      });
    </script>
  </body>
</html>
