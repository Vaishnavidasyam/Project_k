<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timetable Management</title>
    <link rel="stylesheet" href="styles13.css" />
  </head>
  <body>
      <!-- Header -->
      <header class="header">
        <div class="logo">
          <img src="icon.png" alt="Logo" class="logo-icon" />
          University Timetable
        </div>
        <nav class="nav-links">
          <a href="first.html">Home</a>
          <a onclick="showAbout()">About</a>
          <a onclick="showContact()">Contact</a>
        </nav>
      </header>

      <!-- About Modal -->
      <div id="aboutModal" class="popup-overlay">
        <div class="popup-content">
          <button class="popup-close" onclick="closeModal('aboutModal')">
            ×
          </button>
          <h2>About This Website</h2>
          <p>
            This web page displays a provisional timetable for B.Tech students at
            JNTUH College of Engineering Hyderabad.
          </p>
        </div>
      </div>
      <!-- Contact Modal -->
      <div id="contactModal" class="popup-overlay">
        <div class="popup-content">
          <button class="popup-close" onclick="closeModal('contactModal')">
            ×
          </button>
          <h2>Contact Us</h2>
          <p><strong>Name:</strong> SHAIK FAYAZ</p>
          <p><strong>Email:</strong> sahaikfayaz73822@gmail.com</p>
          <p>
            <strong>Address:</strong> Dept. of CSE, JNTUH, Hyderabad, Kukatpally
          </p>
        </div>
      </div>

    <div class="container">
      <!-- Menu -->
      <div class="menu-container">
        <button class="menu-toggle" onclick="toggleMenu()">☰</button>
        <div id="menuItems" class="menu-items">
          <button class="menu-btn" onclick="openAddSubjectPopup()">
            Add Subject
          </button>
          <button class="menu-btn" onclick="goToCT2()">
            Assign Faculty to Subjects
          </button>
          <button class="menu-btn" onclick="goToCT3()">View Timetable</button>
          <button class="menu-btn" onclick="goToCT4()">Add Students</button>
        </div>
      </div>

      <h2>Manage Timetable</h2>
      <div id="semesterSection">
        Class: <span id="class"></span> | Section: <span id="section"></span>
      </div>

      <!-- Timetable -->
      <table id="timetable">
        <thead>
          <tr>
            <th>Day</th>
            <th>9:30 AM – 11:00 AM<br /><small>(2 sections)</small></th>
            <th>11:00 AM – 12:30 PM</th>
            <th>1:45 PM – 3:15 PM<br /><small>(2 sections)</small></th>
            <th>3:15 PM – 4:45 PM</th>
          </tr>
        </thead>
        <tbody>
          <!-- Monday–Saturday -->
          <tr data-day="Monday">
            <td>Monday</td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="9:30 AM - 11:00 AM">
                  <option value="">Select Subject</option></select
                ><input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="11:00 AM - 12:30 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="1:45 PM - 3:15 PM">
                  <option value="">Select Subject</option></select
                ><input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="3:15 PM - 4:45 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
          </tr>
          <tr data-day="Tuesday">
            <td>Tuesday</td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="9:30 AM - 11:00 AM">
                  <option value="">Select Subject</option></select
                ><input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="11:00 AM - 12:30 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="1:45 PM - 3:15 PM">
                  <option value="">Select Subject</option></select
                ><input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="3:15 PM - 4:45 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
          </tr>
          <tr data-day="Wednesday">
            <td>Wednesday</td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="9:30 AM - 11:00 AM">
                  <option value="">Select Subject</option></select
                ><input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="11:00 AM - 12:30 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="1:45 PM - 3:15 PM">
                  <option value="">Select Subject</option></select
                ><input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="3:15 PM - 4:45 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
          </tr>
          <tr data-day="Thursday">
            <td>Thursday</td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="9:30 AM - 11:00 AM">
                  <option value="">Select Subject</option></select
                ><input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="11:00 AM - 12:30 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="1:45 PM - 3:15 PM">
                  <option value="">Select Subject</option></select
                ><input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="3:15 PM - 4:45 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
          </tr>
          <tr data-day="Friday">
            <td>Friday</td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="9:30 AM - 11:00 AM">
                  <option value="">Select Subject</option></select
                ><input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="11:00 AM - 12:30 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="1:45 PM - 3:15 PM">
                  <option value="">Select Subject</option></select
                ><input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="3:15 PM - 4:45 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
          </tr>
          <tr data-day="Saturday">
            <td>Saturday</td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="9:30 AM - 11:00 AM">
                  <option value="">Select Subject</option></select
                ><input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="11:00 AM - 12:30 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="1:45 PM - 3:15 PM">
                  <option value="">Select Subject</option></select
                ><input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="3:15 PM - 4:45 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
          </tr> 
          </tr>
        </tbody>
      </table>

      <div class="footer">
        <button onclick="window.history.back()">Back</button>
        <button onclick="saveTimetable()">Save Timetable</button>
      </div>
    </div>

    <!-- Add Subject Popup -->
    <div id="addSubjectPopup" class="popup-overlay">
      <div class="popup-content">
        <button class="popup-close" onclick="closeAddSubjectPopup()">×</button>
        <h3>Add New Subject</h3>
        <input type="text" id="newSubjectName" placeholder="Enter Subject Name" />
        <button onclick="saveNewSubject()">Save</button>
      </div>
    </div>

    <script>
      // Toggle menu
         // Toggle menu display
        function toggleMenu(event) {
           const m = document.getElementById("menuItems");
          m.style.display = m.style.display === "block" ? "none" : "block";
        }
      
        // Close menu when clicking outside
        document.addEventListener("click", function (event) {
          const menu = document.getElementById("menuItems");
          const toggleBtn = document.getElementById("menuToggle");
      
          if (menu.style.display === "block" && !menu.contains(event.target) && !toggleBtn.contains(event.target)) {
            menu.style.display = "none";
          }
        });
       
      // Get URL params
      function getQueryParams() {
        const p = new URLSearchParams(window.location.search);
        return {
          semester: p.get("semester"),
          class: p.get("class"),
          room: p.get("room"),
          department: p.get("department"),
        };
      }

      // Move selected option just under placeholder
      function moveOptionToTop(selectElem, val) {
        const opts = Array.from(selectElem.options);
        const idx = opts.findIndex((o) => o.value === val);
        if (idx > 1) {
          const opt = opts[idx];
          selectElem.remove(idx);
          selectElem.add(opt, selectElem.options[1]);
        }
      }

      // Setup two-section checkbox logic
      function setupTwoSectionCheckboxes() {
        document.querySelectorAll(".two-section-checkbox").forEach((cb) => {
          cb.addEventListener("change", () => {
            const cell = cb.closest("td");
            const next = cell.nextElementSibling;
            if (cb.checked) {
              cell.colSpan = 2;
              if (next) next.style.display = "none";
            } else {
              cell.colSpan = 1;
              if (next) next.style.display = "";
            }
          });
        });
      }

      // Fetch and pre-select saved entries
      function fetchTimetable() {
        const qp = getQueryParams();
        return fetch(
          `get_timetable.php?semester=${qp.semester}&class=${qp.class}&room=${qp.room}&department=${qp.department}`
        )
          .then((r) => r.json())
          .then((data) => {
            data.forEach((entry) => {
              const day = entry.day;
              const time = entry.time_slot;
              const subj = entry.subject;
              const two = +entry.two_sections === 1;
              const sel = document.querySelector(
                `tr[data-day="${day}"] select.subjectDropdown[data-time="${time}"]`
              );
              if (!sel) return;
              sel.value = subj;
              moveOptionToTop(sel, subj);
              if (two) {
                const cb = sel
                  .closest("td")
                  .querySelector(".two-section-checkbox");
                cb.checked = true;
                cb.dispatchEvent(new Event("change"));
              }
            });
          })
          .catch(console.error);
      }

      // Save timetable
      function showAlert(message, type = 'success') {
        const alertBox = document.createElement('div');
        alertBox.textContent = message;
        alertBox.style.position = 'fixed';
        alertBox.style.top = '20px';
        alertBox.style.right = '20px';
        alertBox.style.padding = '15px 20px';
        alertBox.style.zIndex = '9999';
        alertBox.style.borderRadius = '8px';
        alertBox.style.fontSize = '16px';
        alertBox.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
        alertBox.style.color = '#fff';
        alertBox.style.backgroundColor = (type === 'success') ? '#28a745' : '#dc3545'; // green or red
      
        document.body.appendChild(alertBox);
      
        setTimeout(() => {
          alertBox.remove();
        }, 4000);
      }
      
      function saveTimetable() {
        const qp = getQueryParams();
        const rows = document.querySelectorAll("#timetable tbody tr");
        const payload = [];
        rows.forEach((row) => {
          const day = row.dataset.day;
          row.querySelectorAll(".slot").forEach((slot) => {
            const sel = slot.querySelector("select.subjectDropdown");
            const cb = slot.querySelector(".two-section-checkbox");
            if (!sel) return;
            const subj = sel.value;
            const time = sel.dataset.time;
            const two = cb ? cb.checked : false;
            if (subj)
              payload.push({
                day,
                time,
                subject: subj,
                twoSections: two,
                semester: qp.semester,
                class: qp.class,
                room: qp.room,
                department: qp.department,
              });
          });
        });
      
        fetch("save_timetable.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
        .then(response => response.text())
        .then(data => {
          if (data.trim() === "Success") {
            showAlert("Timetable saved successfully!", "success");
          } else {
            showAlert(data, "error"); // Show server message if conflict or error
          }
        })
        .catch((error) => {
          console.error(error);
          showAlert("An error occurred while saving!", "error");
        });
      }
      

      // Navigation
      function goToCT2() {
        window.location.href = `hodCT2.html?${new URLSearchParams(
          getQueryParams()
        )}`;
      }
      function goToCT3() {
        window.location.href = `hodCT3.html?${new URLSearchParams(
          getQueryParams()
        )}`;
      }
      function goToCT4() {
        window.location.href = `student_list.html?${new URLSearchParams(
          getQueryParams()
        )}`;
      }

      // Add Subject popup
      function openAddSubjectPopup() {
        document.getElementById("addSubjectPopup").style.display = "flex";
      }
      function closeAddSubjectPopup() {
        document.getElementById("addSubjectPopup").style.display = "none";
      }
      function saveNewSubject() {
        const name = document.getElementById("newSubjectName").value.trim();
        if (!name) return alert("Please enter a subject name.");
        const qp = getQueryParams();
        fetch("save_subject.php", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            subject: name,
            semester: qp.semester,
            class: qp.class,
            room: qp.room,
            department: qp.department,
          }),
        })
          .then((r) => r.json())
          .then((data) => {
            if (data.status === "success") {
              alert(data.message);
              closeAddSubjectPopup();
            } else alert("Error: " + data.message);
          })
          .catch(console.error);
      }

      // About/Contact modals
      function showAbout() {
        document.getElementById("aboutModal").style.display = "flex";
      }
      function showContact() {
        document.getElementById("contactModal").style.display = "flex";
      }
      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }
      window.onclick = (e) => {
        if (e.target.classList.contains("popup-overlay"))
          e.target.style.display = "nil";
      };

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        // Fetch query parameters from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const semester = urlParams.get('semester');
        const className = urlParams.get('class');
        const room = urlParams.get('room');
        const department = urlParams.get('department');
      
        // Fetch subjects based on query parameters
        fetch(`get_subjects.php?semester=${semester}&class=${className}&room=${room}&department=${department}`)
          .then((r) => r.json())
          .then((subjects) => {
            document.querySelectorAll(".subjectDropdown").forEach((dd) => {
              subjects.forEach((s) => dd.add(new Option(s, s)));
            });
          })
          .then(() => {
            setupTwoSectionCheckboxes();
            return fetchTimetable();
          })
          .catch(console.error);
            
      
        const qp = getQueryParams();
        document.getElementById("class").innerText = qp.class;
        document.getElementById("section").innerText = qp.semester;
      });
    </script>
  </body>
</html>
