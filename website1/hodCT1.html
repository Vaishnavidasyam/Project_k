<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timetable Management</title>

    <link rel="stylesheet" href="styles13.css" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <img src="icon.png" alt="Logo" class="logo-icon" />
        University Timetable
      </div>
      <nav class="nav-links">
        <a href="first.html">Home</a>
        <a onclick="showAbout()">About</a>
        <a onclick="showContact()">Contact</a>
      </nav>
    </header>

    <!-- About Modal -->
    <div id="aboutModal" class="popup-overlay">
      <div class="popup-content">
        <button class="popup-close" onclick="closeModal('aboutModal')">
          ×
        </button>
        <h2>About This Website</h2>
        <p>
          This web page displays a provisional timetable for B.Tech students at
          JNTUH College of Engineering Hyderabad.
        </p>
      </div>
    </div>
    <!-- Contact Modal -->
    <div id="contactModal" class="popup-overlay">
      <div class="popup-content">
        <button class="popup-close" onclick="closeModal('contactModal')">
          ×
        </button>
        <h2>Contact Us</h2>
        <p><strong>Name:</strong> SHAIK FAYAZ</p>
        <p><strong>Email:</strong> sahaikfayaz73822@gmail.com</p>
        <p>
          <strong>Address:</strong> Dept. of CSE, JNTUH, Hyderabad, Kukatpally
        </p>
      </div>
    </div>

    <div class="container">
      <!-- Menu -->
      <div class="menu-container">
        <button class="menu-toggle" onclick="toggleMenu()">☰</button>
        <div id="menuItems" class="menu-items">
          <button class="menu-btn" onclick="openAddSubjectPopup()">
            Add Subject
          </button>
          <button class="menu-btn" onclick="goToCT2()">
            Assign Faculty to Subjects
          </button>
          <button class="menu-btn" onclick="goToCT3()">View Timetable</button>
          <button class="menu-btn" onclick="goToCT4('Add Students')">
            Add Students
          </button>
        </div>
      </div>

      <h2>Manage Timetable</h2>
      <div id="semesterSection">Semester: 3-1 | Section: Regular</div>

      <!-- Timetable -->
      <table id="timetable">
        <thead>
          <tr>
            <th>Day</th>
            <th>9:30 AM – 11:00 AM<br /><small>(2 sections)</small></th>
            <th>11:00 AM – 12:30 PM</th>
            <th>1:45 PM – 3:15 PM<br /><small>(2 sections)</small></th>
            <th>3:15 PM – 4:45 PM</th>
          </tr>
        </thead>
        <tbody>
          <!-- Monday -->
          <tr data-day="Monday">
            <td>Monday</td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="9:30 AM - 11:00 AM">
                  <option value="">Select Subject</option>
                </select>
                <input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="11:00 AM - 12:30 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="1:45 PM - 3:15 PM">
                  <option value="">Select Subject</option>
                </select>
                <input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="3:15 PM - 4:45 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
          </tr>
          <!-- Tuesday -->
          <tr data-day="Tuesday">
            <td>Tuesday</td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="9:30 AM - 11:00 AM">
                  <option value="">Select Subject</option>
                </select>
                <input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="11:00 AM - 12:30 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="1:45 PM - 3:15 PM">
                  <option value="">Select Subject</option>
                </select>
                <input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="3:15 PM - 4:45 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
          </tr>
          <!-- Wednesday -->
          <tr data-day="Wednesday">
            <td>Wednesday</td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="9:30 AM - 11:00 AM">
                  <option value="">Select Subject</option>
                </select>
                <input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="11:00 AM - 12:30 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="1:45 PM - 3:15 PM">
                  <option value="">Select Subject</option>
                </select>
                <input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="3:15 PM - 4:45 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
          </tr>
          <!-- Thursday -->
          <tr data-day="Thrusday">
            <td>Thursday</td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="9:30 AM - 11:00 AM">
                  <option value="">Select Subject</option>
                </select>
                <input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="11:00 AM - 12:30 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="1:45 PM - 3:15 PM">
                  <option value="">Select Subject</option>
                </select>
                <input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="3:15 PM - 4:45 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
          </tr>
          <!-- Friday -->
          <tr data-day="Friday">
            <td>Friday</td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="9:30 AM - 11:00 AM">
                  <option value="">Select Subject</option>
                </select>
                <input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="11:00 AM - 12:30 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="1:45 PM - 3:15 PM">
                  <option value="">Select Subject</option>
                </select>
                <input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="3:15 PM - 4:45 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
          </tr>
          <!-- Saturday -->
          <tr data-day="Saturday">
            <td>Saturday</td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="9:30 AM - 11:00 AM">
                  <option value="">Select Subject</option>
                </select>
                <input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="11:00 AM - 12:30 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
            <td class="slot two-slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="1:45 PM - 3:15 PM">
                  <option value="">Select Subject</option>
                </select>
                <input type="checkbox" class="two-section-checkbox" />
              </div>
            </td>
            <td class="slot">
              <div class="cell-group">
                <select class="subjectDropdown" data-time="3:15 PM - 4:45 PM">
                  <option value="">Select Subject</option>
                </select>
              </div>
            </td>
          </tr>
          <!-- End of Saturday -->
        </tbody>
      </table>

      <div class="footer">
        <button onclick="window.history.back()">Back</button>
        <button id="saveButton" onclick="saveTimetable()">Save</button>
      </div>
    </div>

    <!-- Add Subject Popup -->
    <div id="addSubjectPopup" class="popup-overlay">
      <div class="popup-content">
        <button class="popup-close" onclick="closeAddSubjectPopup()">×</button>
        <h3>Add New Subject</h3>
        <input type="text" id="newSubjectName" placeholder="Subject Name" />
        <button onclick="saveNewSubject()">Save</button>
      </div>
    </div>

    <script>
      function toggleMenu() {
        const m = document.getElementById("menuItems");
        m.style.display = m.style.display === "block" ? "none" : "block";
      }
      function getFacultyBySubject(subject) {
        return fetch("get_faculty.php?subject=" + encodeURIComponent(subject))
          .then((response) => response.json())
          .then((data) => data.faculty);
      }

      function goToCT2() {
        const params = getQueryParams();
        const url = new URL("hodCT2.html", window.location.href);
        url.search = new URLSearchParams(params).toString();
        window.location.href = url.toString();
      }

      function goToCT3() {
        const params = getQueryParams();
        const url = new URL("hodCT3.html", window.location.href);
        url.search = new URLSearchParams(params).toString();
        window.location.href = url.toString();
      }

      function goToCT4() {
        const params = getQueryParams();
        const url = new URL("student_list.html", window.location.href);
        url.search = new URLSearchParams(params).toString();
        window.location.href = url.toString();
      }
      function openAddSubjectPopup() {
        document.getElementById("addSubjectPopup").style.display = "flex";
      }
      function closeAddSubjectPopup() {
        document.getElementById("addSubjectPopup").style.display = "none";
      }
      // Function to get query parameters from the URL
      function getQueryParams() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
          semester: urlParams.get("semester"),
          class: urlParams.get("class"),
          room: urlParams.get("room"),
          department: urlParams.get("department"),
        };
      }

      function saveNewSubject() {
        const name = document.getElementById("newSubjectName").value.trim();
        if (!name) return alert("Please enter a subject name.");

        const params = getQueryParams();
        fetch("save_subject.php", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            subject: name,
            semester: params.semester,
            class: params.class,
            room: params.room,
            department: params.department,
          }).toString(),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              alert(data.message);
              closeAddSubjectPopup();
            } else {
              alert("Error: " + data.message);
            }
          })
          .catch((error) => alert("Error: " + error));
      }
      function showAbout() {
        document.getElementById("aboutModal").style.display = "flex";
      }
      function showContact() {
        document.getElementById("contactModal").style.display = "flex";
      }
      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }
      window.onclick = function (e) {
        if (e.target.classList.contains("popup-overlay")) {
          e.target.style.display = "none";
        }
      };
      document.querySelectorAll(".two-section-checkbox").forEach((cb) => {
        cb.addEventListener("change", function () {
          const cell = this.closest("td"),
            row = cell.parentElement,
            idx = Array.from(row.children).indexOf(cell);

          if (this.checked) {
            // When checked, merge the two cells (set colSpan to 2) and remove the second cell
            const right = row.children[idx + 1];
            cell.colSpan = 2; // Make this cell span two columns
            right.remove(); // Remove the second cell (the one to the right)

            // Add the extra checkbox in the second section if it doesn't exist
            if (!right.querySelector(".two-section-checkbox")) {
              const extraCheckbox = document.createElement("input");
              extraCheckbox.type = "checkbox";
              extraCheckbox.classList.add("two-section-checkbox");
              right.appendChild(extraCheckbox);
            }
          } else {
            // When unchecked, revert the first cell and restore the second cell
            cell.removeAttribute("colSpan"); // Reset colSpan to default (1)

            // Remove the second checkbox if it exists (created during merge)
            const secondCheckbox = row.querySelectorAll(
              ".two-section-checkbox"
            )[1];
            if (secondCheckbox) {
              secondCheckbox.remove();
            }

            // Re-add the second cell (if it's removed)
            const newCell = document.createElement("td");
            newCell.classList.add("slot");
            newCell.innerHTML = `<div class="cell-group"><select class="subjectDropdown"><option value="">Select Subject</option></select></div>`;
            row.insertBefore(newCell, row.children[idx + 1]);
          }
        });
      });

      document.addEventListener("DOMContentLoaded", function () {
        fetch("get_subjects.php")
          .then((response) => response.json())
          .then((subjects) => {
            const dropdowns = document.querySelectorAll(".subjectDropdown");
            dropdowns.forEach((dropdown) => {
              subjects.forEach((subject) => {
                const option = document.createElement("option");
                option.value = subject;
                option.textContent = subject;
                dropdown.appendChild(option);
              });
            });
          })
          .catch((error) => console.error("Error loading subjects:", error));
      });
      function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name); // Return the value of the query parameter by name
      }

      // Example usage:
      const semester = getQueryParam("semester"); // "2-1"
      const classType = getQueryParam("class"); // "IDP"
      const department = getQueryParam("department"); // "cse"
      const room = getQueryParam("room"); // "G2"

      console.log(
        `Semester: ${semester}, Class: ${classType}, Department: ${department}, Room: ${room}`
      );
      function saveTimetable() {
        const timetableData = [];

        // Loop through each day row in the timetable
        const rows = document.querySelectorAll("#timetable tbody tr");
        rows.forEach((row) => {
          const day = row.dataset.day;
          const slots = [];

          // Loop through each slot in the row (each time slot)
          const cells = row.querySelectorAll(".slot");
          cells.forEach((cell) => {
            const select = cell.querySelector("select");
            const checkbox = cell.querySelector('input[type="checkbox"]');
            const subject = select.value; // Get the selected subject
            const twoSections = checkbox.checked; // Check if the two-section checkbox is checked

            // Store the subject and two-section status for this time slot
            slots.push({
              subject: subject,
              twoSections: twoSections,
            });
          });

          // Store the data for each day
          timetableData.push({
            day: day,
            slots: slots,
          });
        });

        // Convert the timetable data to JSON
        const jsonData = JSON.stringify(timetableData);

        // Send the data to the server (for example, using fetch)
        fetch("save_timetable.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: jsonData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Timetable saved successfully!");
            } else {
              alert("Error saving timetable.");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error saving timetable.");
          });
      }
    </script>
  </body>
</html>
