<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timetable Selection</title>
    <link rel="stylesheet" href="styles6.css" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <img src="icon.png" alt="Logo" class="logo-icon" />
        University Timetable
      </div>
      <nav class="nav-links">
        <a href="first.html">Home</a>
        <a href="#" onclick="showAbout()">About</a>
        <a href="#" onclick="showContact()">Contact</a>
      </nav>
    </header>

    <!-- About Modal -->
    <div id="aboutModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('aboutModal')">&times;</span>
        <h2>About This Website</h2>
        <p>
          This web page displays a provisional timetable for B.Tech students at
          JNTUH College of Engineering Hyderabad.
        </p>
        <p>
          The timetable updates dynamically based on the semester and section
          parameters in the URL.
        </p>
      </div>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('contactModal')">&times;</span>
        <h2>Contact Us</h2>
        <p><strong>Name:</strong> SHAIK FAYAZ</p>
        <p><strong>Email:</strong> sahaikfayaz73822@gmail.com</p>
        <p>
          <strong>Address:</strong> Dept. of CSE, JNTUH , Hyderabadl, kukatpally
        </p>
      </div>
    </div>

    <style>
      .nav-links a {
        color: white;
        text-decoration: none;
        margin-left: 15px;
        font-weight: bold;
      }
      .nav-links a:hover {
        text-decoration: underline;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 20px;
        border-radius: 10px;
        width: 80%;
        max-width: 500px;
        position: relative;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .close {
        position: absolute;
        right: 20px;
        top: 10px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #888;
      }

      .close:hover {
        color: black;
      }
    </style>

    <script>
      function showAbout() {
        document.getElementById("aboutModal").style.display = "block";
      }

      function showContact() {
        document.getElementById("contactModal").style.display = "block";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      };
    </script>

    <!-- Main Container -->
    <div class="main-container">
      <div class="form-box">
        <h2>Select Details for Timetable</h2>
        <form id="timetableForm">
          <div class="form-group">
            <label for="semester">Semester</label>
            <select id="semester" required>
              <option value="">Select semester</option>
              <option value="1-1">1-1</option>
              <option value="1-2">1-2</option>
              <option value="2-1">2-1</option>
              <option value="2-2">2-2</option>
              <option value="3-1">3-1</option>
              <option value="3-2">3-2</option>
              <option value="4-1">4-1</option>
              <option value="4-2">4-2</option>
            </select>
          </div>

          <div class="form-group">
            <label for="class">Class</label>
            <select id="class" required>
              <option value="">Select Class</option>
              <option value="Regular">Regular</option>
              <option value="IDP">IDP</option>
              <option value="IDDMP">IDDMP</option>
            </select>
          </div>

          <div class="form-group">
            <label for="room">Select Room</label>
            <select id="room" required>
              <option value="">Select room</option>
              <!-- G1 to G11 -->
              <option value="G1">G1</option>
              <option value="G2">G2</option>
              <option value="G3">G3</option>
              <option value="G4">G4</option>
              <option value="G5">G5</option>
              <option value="G6">G6</option>
              <option value="G7">G7</option>
              <option value="G8">G8</option>
              <option value="G9">G9</option>
              <option value="G10">G10</option>
              <option value="G11">G11</option>
              <!-- 101 to 110 -->
              <option value="101">101</option>
              <option value="102">102</option>
              <option value="103">103</option>
              <option value="104">104</option>
              <option value="105">105</option>
              <option value="106">106</option>
              <option value="107">107</option>
              <option value="108">108</option>
              <option value="109">109</option>
              <option value="110">110</option>
              <!-- 201 to 210 -->
              <option value="201">201</option>
              <option value="202">202</option>
              <option value="203">203</option>
              <option value="204">204</option>
              <option value="205">205</option>
              <option value="206">206</option>
              <option value="207">207</option>
              <option value="208">208</option>
              <option value="209">209</option>
              <option value="210">210</option>
            </select>
          </div>

          <div class="button-group">
            <button
              type="button"
              class="cancel-btn"
              onclick="window.location.href='first.html'"
            >
              Cancel <img src="cancel.png" alt="Cancel Icon" class="btn-icon" />
            </button>

            <button type="submit" class="next-btn">
              Next <img src="signin.png" alt="Next Icon" class="btn-icon" />
            </button>
          </div>
        </form>
      </div>
    </div>
    <script>
      // Extract department from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const department = urlParams.get("department");

      // Event listener for form submission
      document
        .getElementById("timetableForm")
        .addEventListener("submit", function (event) {
          event.preventDefault(); // Prevent the form from submitting normally

          // Get values from form fields
          var semester = document.getElementById("semester").value;
          var classValue = document.getElementById("class").value;
          var room = document.getElementById("room").value;

          // Check if all fields are filled
          if (!semester || !classValue || !room) {
            alert("Please select all fields!");
            return;
          }

          // Step 1: Check if the semester, class, and room combination exists in the database
          fetch(
            `check_log.php?semester=${encodeURIComponent(
              semester
            )}&class=${encodeURIComponent(
              classValue
            )}&room=${encodeURIComponent(room)}`
          )
            .then((response) => response.json())
            .then((data) => {
              // If the combination is being re-selected (same semester, class, and room), allow it without alert
              if (data.room_exists && data.semclass_exists) {
                window.location.href = `hodCT1.html?semester=${encodeURIComponent(
                  semester
                )}&class=${encodeURIComponent(
                  classValue
                )}&room=${encodeURIComponent(
                  room
                )}&department=${encodeURIComponent(department)}`;
              } else if (data.room_exists) {
                // If the room is already assigned to a different semester/class, alert the user
                alert(
                  "This room is already assigned to another semester/class. Please select another room."
                );
              } else if (data.semclass_exists) {
                // If the semester/class combination is already assigned to a different room, alert the user
                alert(
                  "This semester and class are already assigned to another room."
                );
              } else {
                // Step 2: If no conflicts, insert data into the database
                const formData = new FormData();
                formData.append("semester", semester);
                formData.append("class", classValue);
                formData.append("room", room);
                formData.append("department", department);

                // Insert the data into the database
                fetch("insert_log.php", {
                  method: "POST",
                  body: formData,
                })
                  .then((response) => response.text())
                  .then((result) => {
                    // Check if the data was successfully saved
                    if (result.trim() === "success") {
                      // Step 3: Redirect to the timetable page
                      window.location.href = `hodCT1.html?semester=${encodeURIComponent(
                        semester
                      )}&class=${encodeURIComponent(
                        classValue
                      )}&room=${encodeURIComponent(
                        room
                      )}&department=${encodeURIComponent(department)}`;
                    } else {
                      alert("Error saving data!");
                    }
                  })
                  .catch((error) => {
                    console.error("Error:", error);
                    alert("Something went wrong!");
                  });
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Something went wrong!");
            });
        });
    </script>
  </body>
</html>
